<!DOCTYPE html>
<html>
  <head>
    <title>Web Services and Symfony Core Initiative</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <!-- jQuery + history plugin -->
    <script type="text/javascript" src="src/jquery.min.js"></script>
    <script type="text/javascript" src="src/jquery.history.js"></script>

    <!-- Slippy core js file -->
    <script type="text/javascript" src="src/slippy.js"></script>

    <!-- Slippy structural styles -->
    <link type="text/css" rel="stylesheet" href="src/slippy.css"/>

    <!-- Slippy theme (feel free to change it) -->
    <link type="text/css" rel="stylesheet" href="src/slippy-pure.css"/>

    <!-- Specific styles for this presentation -->
    <link type="text/css" rel="stylesheet" href="wscci.css"/>

    <!-- Syntax highlighting core file  -->
    <script type="text/javascript" src="src/highlighter/shCore.js"></script>
    <script type="text/javascript" src="src/highlighter/shBrushPhp.js"></script>

    <!-- Syntax highlighting brushes, this one is only for javascript -->
    <script type="text/javascript" src="src/highlighter/shBrushJScript.js"></script>

    <!-- Syntax highlighting core CSS and a theme -->
    <link type="text/css" rel="stylesheet" href="src/highlighter/shCore.css"/>
    <link type="text/css" rel="stylesheet" href="src/highlighter/shThemeEclipse.css"/>

    <script type="text/javascript">
      $(function() {
          $(".slide").slippy({
            //animLen: 0,
            margin: 0.05
          });
          SyntaxHighlighter.all();
      });
    </script>

  </head>
  <body>

<div class="footer">
  <span class="right"><a href="irc://freenode/#drupal-wscci">#drupal-wscci IRC</a></span>
  <span style="text-align: center">DrupalCon Munich 2012</span>
  <span class="left"><a href="http://groups.drupal.org/wscci">groups.drupal.org/wscci</a></span>
  <hr class="defloat" />
</div>

<section class="slide" id="session-title" data-background="images/first-slide.png">
  <div style="background-color: wheat; margin-top: 60%; padding: 0.25em;">
    <h1>Web Services and <strike>Context</strike> Symfony<br/>Core Initiative</h1>
    <h2>by Larry Garfield</h2>
    <h2>Wednesday 22 August 2012</h2>
  </div>
</section>

<section class="slide">
  <h1>@Crell</h1>
  <div style="width: 50%; float: right; ">
    <img style="max-width: 100%; height: auto;" src="images/crell-nerf.jpg" />
  </div>

  <ul>
    <li>Senior Architect, Palantir.net</li>
    <li>Drupal Association Advisor</li>
    <li>Web Services & Context Initiative Owner</li>
    <li>Co-Author,<br /><em>Drupal 7 Module Development</em>,<br />Packt Publishing</li>
    <li>Architectural Gadfly</li>
    <li>Nerf Gunslinger</li>
  </ul>

  <img style="margin-top: 2em;" src="palantir_horiz_trans.png" />
</section>

<section class="slide">
  <h1>Web Services and Context Core Initiative (WSCCI)</h1>
  <div class="vcenter" style="text-align: center; height: 70%"><img src="images/jack_daniels.jpg" alt="WSCCI" data-credit="http://www.flickr.com/photos/spaterson/4995021726/" /></div>
</section>

<section class="slide">
  <h1>The original plan...</h1>
  <blockquote class="vcenter">The Web Services and Context Core Initiative (WSCCI) aims to
    transform Drupal from a first-class CMS to a first-class REST server with a
    first-class CMS on top of it. To do that, we must give Drupal a unified,
    powerful context system that will support smarter, context- sensitive,
    easily cacheable block-centric layouts and non-page responses using a
    robust unified plugin mechanism.</blockquote>
</section>

<section class="slide">
  <h1 class="vcenter">Huh?</h1>
</section>

<section class="slide">
  <div class="vcenter">
    <h1>REST-First</h1>
    <h1>Development</h1>
  </div>
</section>

<section class="slide">
  <h1 class="vcenter">"Pages" are a special case of REST</h1>
</section>

<section class="slide">
  <h1>Blocks in Drupal 7</h1>
  <div style="text-align: center;"><img src="images/blocks-drupal-7.svg" alt="Blocks in Drupal 7" /></div>
</section>

<section class="slide">
  <h1>Drupal 7 page flow</h1>
  <img src="images/request-flow-drupal-7.svg" />
</section>

<section class="slide">
  <h1>Blocks/Requests in Drupal 8</h1>
  <div style="text-align: center;"><img src="images/blocks-drupal-8.svg" alt="Blocks in Drupal 8" /></div>
</section>

<section class="slide">
  <div class="vcenter" style="text-align: center;"><img src="images/symfony2-logo.png" alt="Symfony2" /></div>
</section>

<section class="slide">
  <h1>Where did Symfony2 come from?</h1>
  <ul>
    <li class="incremental">Just wanted a request/response library</li>
    <li class="incremental">Symfony2 vs. Zend: Symfony2</li>
    <li class="incremental">Oh, wait, they did this already...</li>
  </ul>
</section>

<section class="slide">
  <h1>What is Symfony2?</h1>
  <div class="vcenter">
    <div class="incremental" style="float: left">
      <h2>Symfony2 Components</h2>
      <ul>
        <li>Reusable set of stand-alone libraries</li>
        <li>Solid Object-Oriented toolset</li>
      </ul>
    </div>
    <div class="incremental" style="float: left">
      <h2>Symfony2 Framework</h2>
      <ul>
        <li>Application framework</li>
        <li>Build on top of the Components</li>
      </ul>
    </div>
  </div>
</section>

<section class="slide">
  <h1>So what are we using?</h1>
  <img src="images/symfony2-components.png" />
</section>

<section class="slide">
  <div class="vcenter" style="text-align: center;"><img src="images/drufony.png" alt="Symfony2 + Drupal 8 = Drufony" /></div>
</section>

<section class="slide">
  <h1>Drupal 8 page flow (we hope)</h1>
  <img src="images/request-flow-drupal-8.svg" />
</section>

<section class="slide">
  <h1>HttpKernelInterface</h1>
  <div class="vcenter">
    <pre class="brush: php">
    namespace Symfony\Component\HttpKernel;

    interface HttpKernelInterface {
      /**
       * Handles a request.
       *
       * @param Request $request
       *   A request instance
       * @return $response
       *   A Response instance
       */
      function handle(Request $request, $type = self::MASTER_REQUEST, $catch = true);
    }
    </pre>
   </div>
</section>

<section class="slide">
  <h1>HttpKernel</h1>
  <div class="vcenter" style="text-align: center;"><img src="images/kernel-flow.png" alt="Kernel workflow" /></div>
</section>

<section class="slide">
  <h1 class="vcenter">What have we gotten done...</h1>
</section>

<section class="slide">
  <h1>What have we gotten done...</h1>
  <ol>
    <li class="incremental">Request/Response</li>
    <li class="incremental">Kernel-based workflow</li>
    <li class="incremental">Event Dispatcher</li>
    <li class="incremental">HttpKernel-based request handling</li>
    <li class="incremental">Dependency Injection Container</li>
  </ol>
</section>

<section class="slide">
  <h1 class="vcenter">We have all this awesome, but we're not really using it yet</h1>
</section>

<section class="slide">
  <h1 class="vcenter">If we stop now, we have a horribly over-engineered mess with few benefits</h1>
</section>

<section class="slide">
  <h1 class="vcenter">What do we still <em>have</em> to do...</h1>
</section>

<section class="slide">
  <h1>What do we still <em>have</em> to do</h1>
  <ol>
    <li class="incremental">Finish the new <a href="http://drupal.org/node/1606794">Routing system</a> (still needs ACL)</li>
    <li class="incremental">Upgrade <a href="http://drupal.org/node/1533366">Ajax system</a> to real-REST</li>
    <li class="incremental">Advanced <a href="http://www.github.com/wamilton/BadFaith">Content Negotiation</a></li>
    <li class="incremental">Entity Property API unification (see @fago and @dixon_)</li>
    <li class="incremental">Symfony <a href="http://drupal.org/node/335411">sessions</a></li>
    <li class="incremental"><a href="http://drupal.org/node/1597696">HTTP-based</a> caching</li>
    <li class="incremental">Block URLs (needed for ESI/partial page caching)</li>
    <li class="incremental">Port non-HTML requests to new route (e.g. autocomplete)r</li>
    <li class="incremental">SCOTCH-support (figure out page/block conversion to controllers)</li>
    <li class="incremental">Wither menu links?</li>
  </ol>
</section>

<section class="slide">
  <h1>What do we still <em>want</em> to do</h1>
  <ol>
    <li class="incremental">Entities Serialization (JSON-LD)</li>
    <li class="incremental">Outgoing <a href="http://drupal.org/node/1447736">HTTP requests</a> (Guzzle?)</li>
    <li class="incremental"><a href="http://drupal.org/node/335411">Path</a> alias refactoring</li>
    <li class="incremental">Implement <a href="http://drupal.org/node/1705488">Generators</a> (route-backed <code>url()</code>)</li>
    <li class="incremental">Improved <a href="https://github.com/symfony/symfony/pull/4546">BinaryStreamedResponse</a></li>
    <li class="incremental">Convert more systems to DI</li>
    <li class="incremental">Convert low-level hooks to events</li>
    <li class="incremental">Process form POST earlier to avoid partial page render</li>
    <li class="incremental">Reduce bootstrap to just settings.php and legacy function loading</li>
    <li class="incremental"><a href="http://drupal.org/project/issues/search/drupal?status[]=Open&issue_tags=wscci%2C+kernel-followup">Most of these 30 tagged issues</a></li>
  </ol>
</section>

<section class="slide">
  <h1 class="vcenter">Volunteers?</h1>
</section>

<section class="slide">
  <h1>Symfony2's response API</h1>
  <pre class="brush: php">
  use Symfony\Component\HttpFoundation\Response;

  $response = new Response('No page. :-(', 404, array(
    'Content-Type' => 'text/plain',
  ));

  $response = new Response();
  $response->setContent('Hello World');
  $response->send();
  </pre>
  <div class="incremental">
    <pre class="brush: php">
    use Symfony\Component\HttpFoundation\StreamedResponse;

    $response = new StreamedResponse(function () {
      echo 'foo';
      flush();
      echo 'bar';
    });

    // Later
    $response->send();

    </pre>
  </div>
</section>

<section class="slide">
  <h1 class="vcenter">EventDispatcher</h1>
</section>

<section class="slide">
  <h1>EventDispatcher</h1>
  <p>Like hooks, but</p>
  <ul>
    <li class="incremental">Object-oriented</li>
    <li class="incremental">Testable</li>
    <li class="incremental">More self-evident</li>
    <li class="incremental">Groupable</li>
  </ul>
</section>

<section class="slide">
  <h1>EventDispatcher</h1>
  <pre class="brush: php">
  use Symfony\Component\EventDispatcher\EventDispatcher;

  $dispatcher = new EventDispatcher();

  // Somewhere...
  $callable = function (Event $event) {
    // do something
  };
  $dispatcher->addListener('event_name', $callable);

  // Equivalent of module_invoke_all().
  $dispatcher->dispatch('event_name', new Event());
  </pre>
  <div class="incremental">
    <pre class="brush: php">
    class PlusOneSubscribe implements EventSubscriberInterface {

      public function onMyEvent(Event $event) {
        // Do stuff
      }

      static function getSubscribedEvents() {
        $events['event_name'][] = array('onMyEvent');
        return $events;
      }
    }

    $dispatcher->addSubscriber(new PlusOneSubscribe());
    </pre>
   </div>
</section>

<section class="slide">
  <div class="vcenter">
    <h1>HttpKernel</h1>
    <h1 style="margin-top: 2em;">Routing</h1>
  </div>
</section>

<section class="slide">
  <h1>HttpKernel</h1>
  <ul>
    <li class="incremental">Ties everything together</li>
    <li class="incremental">Map a Request to a Response</li>
  </ul>
</section>

<section class="slide">
  <h1>index.php (before the Container)</h1>
  <div class="vcenter">
    <pre class="brush: php">
    use Drupal\Core\DrupalKernel;
    use Symfony\Component\HttpFoundation\Request;
    use Symfony\Component\EventDispatcher\EventDispatcher;
    use Symfony\Component\HttpKernel\Controller\ControllerResolver;

    // Create a request object from the HTTPFoundation.
    $request = Request::createFromGlobals();

    $dispatcher = new EventDispatcher();
    $resolver = new ControllerResolver();

    $kernel = new DrupalKernel($dispatcher, $resolver);
    $response = $kernel->handle($request);

    $response->prepare($request);
    $response->send();
    $kernel->terminate($request, $response);
    </pre>
   </div>
</section>

<section class="slide">
  <h1 class="vcenter">So what changes?</h1>
</section>

<section class="slide">
  <h1>Controllers</h1>
  <ul>
    <li class="incremental">"Thing the kernel asks for a response."</li>
    <li class="incremental">Page callback, only better!</li>
    <li class="incremental">Block, only better!</li>
    <li class="incremental">Controller == Page callback == Block =></li>
    <li class="incremental"><em>Every block is (can be) a subreqest</em></li>
    <li class="incremental">Every subrequest is HTTP cacheable</li>
  </ul>
</section>

<section class="slide">
  <h1>Routing</h1>
  <p>New routing syntax (farewell <code>hook_menu()</code>?)</p>
  <div class="alert" style="text-align: center; margin-top: 1em; font-size: 1.2em;"><em>Warning, early untested prototype</em></div>

  <pre class="brush: php">
    function example_route_info() {
      $routes['node_page'] = array(
        'route' => new Route('/node/{node}', array(
          '_controller' => 'NodeController:show',
        )),
        // This gets objectified later...
        'access' => array(
          'callback' => array('function' => 'node_access'),
          'arguments' => array('view'),
        ),
      );
      return $routes;
    }

    class NodeController {
      public function show(Node $node) {
        // ...
        return new Response($content);
      }
    }
  </pre>
</section>

<section class="slide">
  <h1>Routing (fancy)</h1>

  <pre class="brush: php">
    function example_route_info() {
      $routes['blog_list'] = array(
        'route' => new Route('/blog/{page}', array(
          '_controller' => 'BlogController:show',
          'page' => 1, // Default value
        ), array(
          'page' => '\d+',
          '_method' => 'GET',
        )),
        // This gets objectified later...
        'access' => array(
          'callback' => array('function' => 'node_access'),
          'arguments' => array('view'),
        ),
      );
      return $routes;
    }

    class BlogController {
      public function show(Request $request, $page) {
        // Link to router items, not random URLs.
        $link = $this->generator->generate('node_page', array('node' => 5));
        // ...
        return new Response($content);
      }
    }
  </pre>
</section>

<section class="slide">
  <h1>Side-benefits</h1>
  <ul>
    <li class="incremental">Cleaner, more modular code</li>
    <li class="incremental">More object-oriented (more testable, if we do it right)</li>
    <li class="incremental">Dependency Injection Container(!)</li>
    <li class="incremental">Lots of knock-on refactoring to clean up old crap</li>
  </ul>
  <h3 class="incremental vcenter" style="text-align: center;">(Please help clean up old crap!)</h3>
</section>

<section class="slide">
  <div  class="vcenter">
    <blockquote>A large part of WSCCI is simply paying down years of<br/>technical debt.</blockquote>
    <blockquote>That means we can do other cool things.</blockquote>
  </div>
</section>

<section class="slide">
  <h1>Things like... SCOTCH</h1>
  <ul>
    <li class="incremental">Blocks and Layout Initiative</li>
    <li class="incremental">"Panels in Core", without the bad parts</li>
    <li class="incremental">Talk to Kris Vanderwater (EclipseGc) and Bojhan</li>
  </ul>
</section>

<section class="slide">
  <h1>Things like... Deployment</h1>
  <ul>
    <li class="incremental">Entity API cleanup</li>
    <li class="incremental">JSON-LD as standard export format</li>
    <li class="incremental">=> Reading/writing nodes via standard web services becomes easy*!</li>
    <li class="incremental"><a href="http://groups.drupal.org/node/237443">Vision</a> - <a href="http://drupal.org/node/1540656">Roadmap</a></li>
    <li class="incremental">Talk to fago or Dixon</li>
  </ul>

  <h3 class="incremental vcenter" style="text-align: center;">[*] The management will not be held responsible if "easy" is insufficiently easy for your client.</h3>
</section>

<section class="slide">
  <h1>Collaboration</h1>
  <ul>
    <li class="incremental">Symfony2: MIT License</li>
    <li class="incremental">Drupal: GPL License</li>
    <li class="incremental">Code only flows one way. :-(</li>
  </ul>
</section>

<section class="slide">
  <h1>Work upstream</h1>
  <ul>
    <li class="incremental">Symfony2 "flash messages": Simple session message persistence</li>
    <li class="incremental"><code>drupal_set_message()</code></li>
    <li class="incremental">Make less code in the world!</li>
    <li class="incremental">Drupalers designed needs for improved API</li>
    <li class="incremental">Drak (of Zikula CMS) implemented it</li>
    <li class="incremental">All Symfony2-based projects benefit!</li>
     <li class="incremental"><a href="http://drupal.org/node/335411">Drupal issue</a>: Reviews desperately needed!</li>
  </ul>
</section>

<section class="slide">
  <h1>Streaming</h1>
  <ul>
    <li class="incremental"><a href="http://www.garfieldtech.com/blog/readfile-memory">http://www.garfieldtech.com/blog/readfile-memory</a></li>
    <li class="incremental"><a href="http://drupal.org/node/1561362">http://drupal.org/node/1561362</a></li>
    <li class="incremental">Make new file stream response object in Symfony/HttpFoundation</li>
    <li class="incremental">We get to use it all over</li>
    <li class="incremental">Everyone else uses it all over</li>
    <li class="incremental"><a href="https://github.com/symfony/symfony/pull/4546">Symfony pull request</a></li>
    <li class="incremental">Make less code in the world!</li>
    <li class="incremental">Volunteers?</li>
  </ul>
</section>

<section class="slide">
  <h1>Odds and ends</h1>
  <ul>
    <li><a href="https://github.com/symfony/symfony/pull/3954"><code>Response::prepare()</code> chaining</a></li>
    <li><a href="https://github.com/symfony/symfony/pull/4017">Improve FlattenException</a></li>
    <li><a href="https://github.com/symfony/symfony/pull/4510">UTF-8 encoding weirdness in JSON</a></li>
    <li><a href="https://github.com/symfony/symfony/pull/4363">Allow Router matching on a full Request</a></li>
    <li><a href="https://github.com/symfony/symfony/pull/4642">Make RouteCollection Countable</a></li>
    <li><a href="https://github.com/symfony/symfony/pull/4755">Improve Route serialization</a></li>

    <li class="incremental" style="margin-top: 2em;">Plenty more to come...</li>
  </ul>
</section>


<section class="slide">
  <h1 class="vcenter">On the Drupal side...</h1>
</section>

<section class="slide">
  <h1>Bundles</h1>
  <ul>
    <li class="incremental">Symfony equivalent of "modules" (sorta kinda)</li>
    <li class="incremental">Registers services and events in the Injection Container</li>
    <li class="incremental">Lets modules be useful in a Symfony-based world!</li>
    <li class="incremental"><a href="http://drupal.org/node/1599108">Drupal issue</a></li>
    <li class="incremental">Volunteers? Talk to me or Kat Bailey</li>
  </ul>
</section>

<section class="slide">
  <h1>Other issues</h1>
  <ul>
    <li class="incremental">Write secure PHP code to disk: <a href="http://drupal.org/node/1675260">Issue</a></li>
    <li class="incremental">Replace drupal_http_request() with Guzzle: <a href="http://drupal.org/node/1447736">Issue</a></li>
    <li class="incremental">Clean up Drupal.ajax system: <a href="http://drupal.org/node/1533366">Issue</a></li>
    <li class="incremental">Replace drupal_goto() with a Response object: <a href="http://drupal.org/node/1668866">Issue</a></li>
    <li class="incremental">Rewrite the installer to not suck: <a href="http://drupal.org/node/1530756">Issue</a></li>

    <li class="incremental" style="margin-top: 2em;">And many more...  Just look for the <a href="http://drupal.org/project/issues/search/drupal?status[]=Open&issue_tags=WSCCI">WSCCI</a> tag.</li>
  </ul>
</section>

<section class="slide">
  <h1>Excited yet?</h1>

  <h3 class="vcenter incremental" style="text-align: center;">I hope so, because we need your help...</h3>
</section>

<section class="slide">
  <div class="vcenter">
    <h1>Questions?</h1>
    <h2 style="text-align: center; margin-top: 3em;"><a href="http://groups.drupal.org/wscci">http://groups.drupal.org/wscci</a></h2>
  </div>
</section>

  </body>
</html>
